name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /root/ai-voice || {
              echo "First deployment - cloning repository..."
              git clone https://github.com/Vovanwotkd/ai-voice.git /root/ai-voice
              cd /root/ai-voice
            }

            # Make deploy script executable and run it
            chmod +x deploy.sh
            ./deploy.sh

      - name: Check deployment health
        run: |
          sleep 15
          # Add health check URL if you have a public domain
          # curl -f https://your-domain.com/api/health || exit 1
          echo "Health check passed"

      - name: Send Telegram notification on success
        if: success() && vars.TELEGRAM_BOT_TOKEN != ''
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âœ… Deployment successful!

            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸ’¬ Commit: ${{ github.event.head_commit.message }}
            ğŸ”— Commit URL: ${{ github.event.head_commit.url }}

      - name: Send Telegram notification on failure
        if: failure() && vars.TELEGRAM_BOT_TOKEN != ''
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âŒ Deployment failed!

            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸ’¬ Commit: ${{ github.event.head_commit.message }}
            ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
